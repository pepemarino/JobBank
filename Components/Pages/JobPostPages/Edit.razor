@page "/jobposts/edit"
@using Microsoft.EntityFrameworkCore
@using JobBank.Models
@inject IDbContextFactory<JobBank.Data.EmploymentBankContext> DbFactory
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Edit Job Post</PageTitle>

<div class="container pb-5">
    <div class="d-flex justify-content-between align-items-center my-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="/jobposts">Job Posts</a></li>
                    <li class="breadcrumb-item active">Edit</li>
                </ol>
            </nav>
            <h1>Edit: @JobPost?.Title</h1>
        </div>
        <a href="/jobposts" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to List
        </a>
    </div>

    @if (JobPost is null)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Fetching job details...</p>
        </div>
    }
    else
    {
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <EditForm method="post" Model="JobPost" OnValidSubmit="UpdateJobPost" FormName="edit" Enhance>
                    <DataAnnotationsValidator />
                    <ValidationSummary class="alert alert-danger" role="alert" />
                    <input type="hidden" name="JobPost.Id" value="@JobPost.Id" />

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="title" class="form-label fw-bold">Job Title</label>
                            <InputText id="title" @bind-Value="JobPost.Title" class="form-control form-control-lg" />
                            <ValidationMessage For="() => JobPost.Title" class="text-danger" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="company" class="form-label fw-bold">Company</label>
                            <div class="input-group">
                                <InputText id="company" @bind-Value="JobPost.Company" class="form-control form-control-lg" />
                                <button id="searchBtn" type="button" class="btn btn-outline-primary">
                                    <i class="bi bi-search"></i> Search Google
                                </button>
                            </div>
                            <ValidationMessage For="() => JobPost.Company" class="text-danger" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label fw-bold">Job Description</label>
                        <InputTextArea id="description" @bind-Value="JobPost.Description" class="form-control mb-2" rows="6" />
                        <button type="button" @onclick="() => HandleLLMSugestion(JobPost.Id)" class="btn btn-sm btn-info text-white">
                            <i class="bi bi-cpu"></i> Ask AI for Suggestions
                        </button>
                        <ValidationMessage For="() => JobPost.Description" class="text-danger" />
                    </div>

                    <hr class="my-4" />

                    <h5 class="text-primary mb-3">Status & Classification</h5>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="jobtype" class="form-label fw-bold">Work Type</label>
                            <InputText id="jobtype" @bind-Value="JobPost.JobType" class="form-control" placeholder="Contract, FT..." />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="jobbase" class="form-label fw-bold">HQ/Location</label>
                            <InputText id="jobbase" @bind-Value="JobPost.JobBase" class="form-control" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="applicationtype" class="form-label fw-bold">Application Method</label>
                            <InputText id="applicationtype" @bind-Value="JobPost.ApplicationType" class="form-control" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="actiontotake" class="form-label fw-bold text-success">Next Step (To Do)</label>
                            <InputText id="actiontotake" @bind-Value="JobPost.ActionToTake" class="form-control border-success" />
                        </div>
                    </div>

                    <div class="row bg-light p-3 rounded-3 mb-4 mx-0">
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <InputCheckbox id="isapplied" @bind-Value="JobPost.IsApplied" class="form-check-input" />
                                <label for="isapplied" class="form-check-label fw-bold">Applied</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <InputCheckbox id="applicationdeclined" @bind-Value="JobPost.ApplicationDeclined" class="form-check-input" />
                                <label for="applicationdeclined" class="form-check-label fw-bold text-danger">Declined</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <InputCheckbox id="ithaschallenge" @bind-Value="JobPost.ItHasChallenge" class="form-check-input" />
                                <label for="ithaschallenge" class="form-check-label fw-bold text-warning">Technical Challenge</label>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4" />

                    <h5 class="text-primary mb-3">Timeline & Interviews</h5>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="applicationdate" class="form-label fw-bold">Date Applied</label>
                            <InputDate id="applicationdate" @bind-Value="JobPost.ApplicationDate" class="form-control" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="responsedate" class="form-label fw-bold">Response Date</label>
                            <InputDate id="responsedate" @bind-Value="JobPost.ResponseDate" class="form-control" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="interviewdate" class="form-label fw-bold text-primary">Interview Date</label>
                            <InputDate id="interviewdate" @bind-Value="JobPost.InterviewDate" class="form-control border-primary" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="interviewtype" class="form-label fw-bold">Interview Type</label>
                            <InputText id="interviewtype" @bind-Value="JobPost.InterviewType" class="form-control" placeholder="Technical, HR, etc." />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="interviewoutcome" class="form-label fw-bold">Interview Outcome</label>
                            <InputText id="interviewoutcome" @bind-Value="JobPost.InterviewOutcome" class="form-control" />
                        </div>
                    </div>

                    <hr class="my-4" />

                    <h5 class="text-primary mb-3">Additional Details</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="contactemail" class="form-label fw-bold">Contact Email</label>
                            <InputText id="contactemail" @bind-Value="JobPost.ContactEmail" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="contactphone" class="form-label fw-bold">Contact Phone</label>
                            <InputText id="contactphone" @bind-Value="JobPost.ContactPhone" class="form-control" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="impression" class="form-label fw-bold">Impression</label>
                            <InputText id="impression" @bind-Value="JobPost.Impression" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="comments" class="form-label fw-bold">Comments</label>
                            <InputText id="comments" @bind-Value="JobPost.Comments" class="form-control" />
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="submit" class="btn btn-success btn-lg px-5 shadow">
                            <i class="bi bi-save"></i> Save Changes
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    }
</div>

@if (IsShowingDetails)
{
    <div class="modal-backdrop">
        <LLMAdvisorComponent JobPostId="@JobPostId" OnClose="CloseModal" />
    </div>
}

@code {

    private bool IsShowingDetails { get; set; } = false;
    private int JobPostId { get; set; }

    [SupplyParameterFromQuery]
    private int Id { get; set; }

    [SupplyParameterFromForm]
    private JobPost? JobPost { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        JobPost ??= await context.JobPost.FirstOrDefaultAsync(m => m.Id == Id);

        if (JobPost is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    public void HandleLLMSugestion(int jobpostId)
    {
        JobPostId = jobpostId;
        IsShowingDetails = true;
    }

    private void CloseModal() => IsShowingDetails = false;

    // To protect from overposting attacks, enable the specific properties you want to bind to.
    // For more information, see https://learn.microsoft.com/aspnet/core/blazor/forms/#mitigate-overposting-attacks.
    private async Task UpdateJobPost()
    {
        using var context = DbFactory.CreateDbContext();
        JobPost!.Timestamp = DateTime.UtcNow;
        context.Attach(JobPost!).State = EntityState.Modified;

        try
        {
            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!JobPostExists(JobPost!.Id))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }

        NavigationManager.NavigateTo("/jobposts", forceLoad: true);
    }

    private bool JobPostExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return context.JobPost.Any(e => e.Id == id);
    }
}
